name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  deploy:
    name: Deploy to Homeserver
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          log-public-key: false

      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          echo "üöÄ Starting deployment to ${{ secrets.DEPLOY_HOST }}..."
          
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            
            echo "üìÅ Navigating to project directory..."
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            echo "üîß Setting up environment..."
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è Warning: .env file not found. Creating from example..."
              cp .env.example .env
            fi
            
            echo "üê≥ Building and restarting containers..."
            docker-compose down
            docker-compose pull
            docker-compose build --no-cache
            docker-compose up -d
            
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            echo "‚úÖ Deployment complete!"
            docker-compose ps
          EOF

      - name: Health check
        run: |
          echo "üè• Running health check..."
          sleep 10
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Check if containers are running
            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Containers are running"
            else
              echo "‚ùå Containers are not running"
              docker-compose logs --tail=50
              exit 1
            fi
            
            # Test health endpoint
            HEALTH_STATUS=$(docker-compose exec -T bmkg-api-server wget -qO- http://localhost:8099/health 2>/dev/null || echo "FAILED")
            if [ "$HEALTH_STATUS" != "FAILED" ]; then
              echo "‚úÖ Health check passed: $HEALTH_STATUS"
            else
              echo "‚ùå Health check failed"
              docker-compose logs --tail=50 bmkg-api-server
              exit 1
            fi
          EOF

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê API is live at: https://bmkg-api.is-a.dev"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs above for details."

  notify:
    name: Send Notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify Discord
        if: secrets.DISCORD_WEBHOOK_URL != ''
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: |
            üöÄ **BMKG API Deployment**
            
            Status: ${{ needs.deploy.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}
            
            URL: https://bmkg-api.is-a.dev
